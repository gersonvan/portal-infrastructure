name: Pull Request Checks

on:
  pull_request:
    branches: [main, develop]

jobs:
  pr-validation:
    name: Validate PR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR title format
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          if [[ ! "$PR_TITLE" =~ ^(feat|fix|docs|style|refactor|test|chore|perf)(\(.+\))?:\ .+ ]]; then
            echo "❌ PR title must follow conventional commits format"
            echo "Examples:"
            echo "  feat: add new feature"
            echo "  fix(backend): resolve authentication issue"
            echo "  docs: update README"
            exit 1
          fi
          echo "✅ PR title format is valid"

      - name: Check for conflicts
        run: |
          git fetch origin ${{ github.base_ref }}
          if git merge-tree $(git merge-base HEAD origin/${{ github.base_ref }}) origin/${{ github.base_ref }} HEAD | grep -q '<<<<<<<'; then
            echo "❌ This PR has merge conflicts. Please resolve them."
            exit 1
          fi
          echo "✅ No merge conflicts detected"

      - name: Check changed files
        run: |
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          echo "Files changed in this PR:"
          echo "$CHANGED_FILES"

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Check for TODO/FIXME comments
        run: |
          echo "Checking for TODO/FIXME comments..."
          if git diff origin/${{ github.base_ref }}...HEAD | grep -E '^\+.*\b(TODO|FIXME)\b'; then
            echo "⚠️ New TODO/FIXME comments detected. Consider creating issues for them."
          else
            echo "✅ No new TODO/FIXME comments"
          fi
        continue-on-error: true

      - name: Check for console.log
        run: |
          echo "Checking for console.log statements..."
          if git diff origin/${{ github.base_ref }}...HEAD -- '*.ts' '*.tsx' '*.js' '*.jsx' | grep -E '^\+.*console\.(log|debug|info)'; then
            echo "⚠️ New console.log statements detected. Consider removing or using proper logging."
          else
            echo "✅ No new console.log statements"
          fi
        continue-on-error: true
